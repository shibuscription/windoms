# Windoms README v0.1

プロジェクト名: **Windoms（Wind Orchestra Management System）**  
吹奏楽専用 管理OS

---

## 1. 目的とコンセプト

Windoms は、吹奏楽クラブの運営に必要な機能を統合する管理システム。

- 日誌
- スケジュール
- シフト
- 会計
- 月謝管理
- 備品管理
- 楽譜・楽器管理

単機能ツールではなく、運営情報を横断して扱える基盤を目指す。

---

## 2. 基本思想

- 年度は 9/1 開始
- 現場負担を増やさない
- リアルタイム入力優先
- 紙運用は急に廃止しない（徐々に置換）
- バッチ処理は極力不要
- 入力負担より「使われ続けること」を優先
- 検索できることが価値
- 将来AI統合可能
- 小さく作って育てる

---

## 3. 用語定義（統一）

- **セッション（枠）**: スケジュールの基本単位
- **日誌**: 1日1枚の実績記録
- **活動ログ（タイムライン）**: 日誌内で時刻順に記録する実施内容

---

## 4. スケジュール管理（計画）

### 4.1 基本構造

- 管理単位は「セッション（枠）」
- 1日は 1〜複数セッションで構成
- 基本運用:
- 平日: 1セッション
- 土日: 基本2セッション
- 「午前/午後」は固定ラベルではなく、UI表示上で違和感なく扱う

TODO: 未決定（セッション名の最終表示ルール）

### 4.2 セッション管理項目

- 活動種別（通常 / 自主練 / イベント）
- 開始時刻 / 終了時刻
- 活動場所（第1/2/3音楽室 or 自由入力）
- 当番必要/不要

### 4.3 .ics 出力

- 月間スケジュール（セッション）から月単位で .ics を生成
- 1セッション = 1イベント

タイトル生成ルール:
- 通常: `【吹奏楽】{当番者名}`
- イベント日: `【吹奏楽】{当番者名} {イベント名}`
- 自主練: `【吹奏楽】自主練`

補足:
- 自主練の見守り担当は、初期仕様ではタイトルに含めない
- LOCATION はスケジュールの活動場所を使用
- イベント時は会場名などを LOCATION として設定可能

### 4.4 Today（日付ビュー）仕様

- Todayは「日付ビュー」として動作する
- URL仕様:
- `/today` は JST基準の本日を表示
- `/today?date=YYYY-MM-DD` は指定日を表示
- `date` が不正値（形式不正 / 実在しない日付）の場合は JST本日にフォールバックする
- 日付ナビUI:
- `← 前日` / `翌日 →` で日付移動し、URLクエリも更新する
- 日付表示（カレンダーアイコン含む）からミニカレンダーを開き、任意日へ移動できる
- ブラウザ戻る / 進むで日付遷移履歴を辿れる
- 日誌との連携:
- 指定日に日誌がある場合は日誌へ遷移できる
- 指定日に日誌がない場合は「日誌を作成」導線を表示する
- 未来日（選択日 > JST本日）で日誌作成する場合は確認ダイアログを表示する

### 4.5 Today備考（notice）表示仕様

- `scheduleDays.notice` はToday上部に表示する（改行反映）
- `scheduleDays.notice` は計画側の連絡事項（Today備考）として扱う
- 初期は3行相当で折りたたむ
- 3行を超える場合のみ、`▼ ひらく / ▲ たたむ` トグルを表示する
- 展開はインラインで行い、全文を読めるようにする
- 展開時は備考エリアが見失われにくいようにスクロール補正する
- 展開後も最大高さを設け、超過分は備考エリア内スクロールで読む

---

## 5. 日誌モジュール（実績ログ）

### 5.1 基本構造

- 日誌は **1日1枚**
- 日誌の `notes` は実績側の記録メモ（日誌メモ）として扱う
- 1日共通情報:
- 活動時間（通し）
- 活動場所（1つ）
- 外部講師（1日単位）
- 先輩（1日単位）
- セッション別に分ける主対象:
- 当番
- 出欠（人数 + 欠席者名任意）
- 日誌画面には Today備考（`scheduleDays.notice`）を表示しない
- Today備考（計画側）と日誌メモ（実績側）は別フィールド・別概念として扱う
- Today備考と日誌メモは相互に同期しない
- 当番ハンコは「予定表示」ではなく「捺印（実績）」で確定する
- 予定当番（計画）と捺印実績（実績）は別概念として扱い、強制同期しない

### 5.2 活動ログ（タイムライン）

- 1日通しで入力
- 時刻順で並ぶ（自動ソート）
- 開始時刻のみ（終了時刻不要）
- 5分刻み
- 初期値は現在時刻に最も近い5分
- 入力はリアルタイム前提（後日入力最適化は不要）

### 5.3 活動種別と曲名

活動種別:
- 筋トレ
- 腹式呼吸
- 基礎練習
- 個人練習
- 合奏
- 休憩
- その他（自由入力）

曲名:
- 合奏は曲名入力あり
- 個人練習も曲名を任意で入力可能
- 曲は複数選択を許容（`songIds`）
- 表示は開始時刻ベースで、必要に応じて「種別（詳細 / 曲名）」を併記する

### 5.4 検索価値

- 曲名検索（初回練習日など）
- 先輩検索（来訪履歴）
- パート検索
- 種別検索

日誌は「練習履歴データベース」として機能する。

### 5.5 実績入力UI方針（講師・先輩）

- `actualInstructors` / `actualSeniors` は配列UIで編集する（カンマ区切り入力は採用しない）
- 追加済みは行リストで表示し、各行の削除で1要素ずつ配列から除去する
- 追加はインライン入力（`＋追加`）で行う
- 候補は入力欄一体型のドロップダウンで表示する
- 候補優先順位は `planned（未追加分）` → `履歴（過去 dayLogs の actual）` → `自由入力`
- 候補クリックで即追加する
- 空文字（trim後）は追加しない
- 重複値は許容する（配列としてそのまま保持）

### 5.6 活動記録UI（一覧・モーダル）

- 一覧は「開始時刻～ / 種別（補足・曲名）」で表示する
- 開始時刻はゼロ埋めしない（例: `9:05`）
- 一覧表示は時刻列を固定幅・右寄せにし、`～` の位置を縦に揃える
- 4桁時刻（例: `16:35～`）でも時刻表示は改行しない
- 活動記録モーダル保存時、`種別` は必須とする
- `種別` 未入力で保存した場合は、保存せずエラー表示する
- エラー表示は `種別` ラベル行の右側に表示する（ドロップダウンに隠れない位置）

### 5.7 活動記録の曲追加UI（DEMO）

- `songIds` は `string[]` で保持し、最大10件
- 曲追加はサジェスト候補タップまたは Enter で行う
- 曲追加UIのアクションは `キャンセル` のみ（`追加` ボタンは置かない）
- 入力文字列は `songMaster.name` と一致する場合のみ追加する（trimして判定）
- 同一曲の重複追加は行わない
- 曲が解決できない場合や重複追加時は、入力欄上にローカルトーストでフィードバックを表示する
- トーストは短時間（約2秒）で自動消去し、連続発生時は上書きする

### 5.8 当番ハンコ（捺印実績）

- 初期表示は未捺印（薄グレー）
- 未捺印時は「予定当番名（計画）」を表示する
- タップで捺印し、赤色表示へ切り替える
- 捺印済みは「捺印者名（実績）」を表示する
- 捺印時に軽いスタンプ演出を行う（過度な演出はしない）
- 他人枠をタップした場合は Confirm を表示し、承認時のみ上書き捺印する
- 同一捺印者が再タップした場合は無反応にせず「捺印済み」等でフィードバックする

---

## 6. 出欠管理

現状:
- 月初に保護者が予定入力
- 実績は未管理

将来:
- 予定出欠入力（部員/保護者）
- 実績は日誌で管理
- パート別出席確認可能

---

## 7. シフト管理

### 7.1 流れ

1. 前月末に当番可能日入力
2. 草案作成（AI利用可能）
3. 手動微調整
4. 月間確定
5. 通知

### 7.2 AI活用（将来）

- 条件ベース初期草案
- 回数バランス考慮
- 可否考慮
- 人間が最終調整

---

## 8. 会計モジュール（簡易出納帳）

### 8.1 財布管理

- ゆうちょ口座
- 会計担当財布
- 会長財布
- 将来複数口座対応

### 8.2 機能

- 収入
- 支出
- 口座間振替
- カテゴリ（2階層）
- 年度繰越
- 年度報告書
- グラフ表示

### 8.3 月謝管理連携

- 4ヶ月ごと集金
- 袋配布リマインド
- 配布済 / 回収済管理
- 未納管理

---

## 9. 備品管理

- 不足報告
- 購入記録
- 会計連携
- レシート画像添付
- 精算待ち管理

---

## 10. 楽譜管理

- 曲名
- 所持数
- パート
- 購入履歴
- 貸出管理（将来）

---

## 11. 楽器管理

現状:
- 紙台帳

将来:
- デジタル貸出
- 使用者管理
- 状態管理
- 部員ロール対応

---

## 12. ロール設計（暫定）

- シス管
- 会計担当
- 役員
- 保護者
- 部員
- 先生

方針:
- モジュール単位で閲覧/編集権限
- 会計は厳格
- 日誌・スケジュールは広く閲覧可
- 将来柔軟拡張

---

## 13. MVP候補

1. スケジュール管理
2. 日誌モジュール
3. シフト管理
4. 会計（簡易版）
5. .ics出力

---

## 14. 設計原則（詳細）

### 14.1 データ整合性ポリシー

- データの正しさはデータモデルで担保する
- フロント補完に依存しない
- 自動生成データには「自動連携フラグ」を持たせる
- 修正・削除は可能とするが、連携取引は警告対象とする
- 集計のためのバッチ前提設計をしない

### 14.2 修正・削除ポリシー

- 実運用を止めない設計にする
- 修正可能な設計を基本とする
- 削除は論理削除も検討する
- 会計連携データは削除制限を検討する

### 14.3 バッチ非依存ポリシー

- 月次締めバッチを前提にしない
- 日次バッチを前提にしない
- リアルタイム入力を即反映させる設計
- 年度切替は明示的に操作する

### 14.4 年度管理ポリシー

- 年度は 9/1 開始
- 年度データは分離可能な構造にする
- 年度繰越は明示的に記録する
- 前年度比較は将来拡張とする

---

## 15. 会計思想

Windomsの会計は「簡易出納帳」であり、複式簿記は対象外とする。

### 15.1 財布中心設計

- すべての取引は「財布」を起点にする
- 財布は複数持てる
- 口座間振替は標準機能

### 15.2 月謝連携

- 月謝管理からの取引は自動生成可能
- 自動生成取引にはフラグを持たせる
- 必要に応じて手動修正可能

### 15.3 精算管理思想

- 立替は「精算待ち」状態を持つ
- レシート画像添付を前提とする
- 精算完了時に会計記帳する

---

## 16. プロダクト哲学

Windomsは「吹奏楽クラブ運営者の心理的・物理的負担を軽減するOS」である。

- シフト作成者の心理的負担を軽減する
- 情報が分散しない安心感を提供する
- 検索可能な履歴を蓄積する
- 運営が属人化しない状態を目指す

---

## 17. 計画と実績の関係

- スケジュールは「計画」を管理する
- 日誌は「実績」を記録する
- 両者は直接の強制同期を行わない
- 必要に応じて参照関係を持つが、自動上書きはしない

---

## 18. データ削除原則

- 実運用データは原則物理削除しない
- 論理削除（isDeleted 等）を基本とする
- 会計データは履歴保持を優先する
- 削除より「無効化」を優先する

---

## 19. データモデル（案）

前提（確定事項）:
- 年度は 9/1 開始
- `YYYY-MM-DD` は年度に依存しない絶対日付として保持する
- `scheduleDays` のIDは `YYYY-MM-DD`
- `scheduleDays/{YYYY-MM-DD}` は docId が `YYYY-MM-DD`（フィールドに `id` / `date` は持たない）
- `sessions` は `scheduleDays/{date}/sessions/{sessionId}` のサブコレクション
- `sessions` のIDは自動ID、並び順は `order`（数値）で保証
- `startTime` / `endTime` は `HH:MM` 文字列（JST前提）、基本30分単位（将来拡張可）
- `type` は最小で `normal` / `self` / `event`
- 保護者が不要な日は無い
- `dutyRequirement` を `sessions` に持つ（`duty` / `watch`）
- `duty` は当番シフト割当対象、`watch` は見守り募集対象
- 当番シフト割当（`duty`）と見守り募集（`watch`）は別機能で扱う
- `requiresShift` は当番シフト割当対象を示す旧フラグで、`dutyRequirement` へ移行する
- 互換期間中に `requiresShift` を持つ場合は `dutyRequirement === "duty"` と同義で扱う
- `location` は `sessions` に持てる
- 入力省力化として `scheduleDays.defaultLocation` を任意で持ち、`session.location` が無い場合は `day.defaultLocation` を継承
- 当番者は `sessions.assignees: [uid]` で保持（運用上は原則1名）
- 表示・ics生成省力化のため `assigneeNameSnapshot` を任意で保持可（UIDが正）
- `plannedInstructors` / `plannedSeniors`（予定の講師・先輩）を `sessions` に持てる
- 曲マスタは `songMaster/{songId}` として保持する（`name` 必須）
- 日誌は `dayLogs/{YYYY-MM-DD}`（1日1枚）
- 日誌から「活動場所」「顧問」は削除（不要）
- 日誌は備考 `notes` を持つ
- `weather` は任意（ワンタップ想定）
- 出欠予定は日単位ではなくセッション単位で管理する（`sessions/{sessionId}/rsvps/{uid}`）
- 日誌はスケジュールを参照して入力を省力化する（第17章の通り強制同期・自動上書きはしない）
- 実績側は `actualInstructors` / `actualSeniors` を持ち、来なかったは「予定にいるが実績にいない」差分で表現する（明示フラグは持たない）
- 捺印実績は `dayLogs.dutyStamps` に保持し、予定当番とは別で扱う

### 19.1 scheduleDays/{date} フィールド例

```json
{
  "defaultLocation": "第1音楽室",
  "notice": "本日16:30に片付け開始です。\n打楽器は搬出前にチェックリストを確認してください。"
}
```

- ドキュメントIDが `YYYY-MM-DD`（フィールドとして保持しない）
- `defaultLocation` は任意
- `notice` は任意（複数行可。Todayでは改行を反映して表示）

### 19.2 sessions/{sessionId} フィールド例

```json
{
  "order": 1,
  "startTime": "09:00",
  "endTime": "12:00",
  "type": "normal",
  "dutyRequirement": "duty",
  "requiresShift": true,
  "location": "第1音楽室",
  "assignees": ["uid_123"],
  "assigneeNameSnapshot": "山田花子",
  "plannedInstructors": ["講師A"],
  "plannedSeniors": ["先輩B"]
}
```

- `sessionId` は自動ID
- 並び順は `order` で制御
- `dutyRequirement` は `duty` / `watch`
- `requiresShift` は旧フラグ（互換）。`dutyRequirement === "duty"` と同義
- `location` 継承の優先順位:
1. `session.location`
2. `scheduleDays.defaultLocation`
3. 未設定（空欄）

### 19.3 dayLogs/{date} 最小フィールド例

```json
{
  "notes": "備考メモ",
  "weather": "晴れ",
  "activities": [
    {
      "startTime": "09:05",
      "type": "基礎練習",
      "title": "ロングトーン",
      "songIds": ["song_001", "song_002"]
    }
  ],
  "dutyStamps": {
    "1": {
      "stampedByUid": "demo_writer",
      "stampedByName": "日誌記入者",
      "stampedAt": "2026-02-15T00:12:34.000Z"
    }
  },
  "actualInstructors": ["講師A"],
  "actualSeniors": ["先輩B"]
}
```

- ドキュメントIDが `YYYY-MM-DD`（フィールドとして保持しない）
- `activities` は活動ログ（開始時刻ベース）
- `activities` は `startTime` 昇順で表示・扱う
- 同一 `startTime` がある場合は登録順で扱う
- `activities.songIds` は任意（0件以上、複数曲を許容）
- `actualInstructors` / `actualSeniors` は `string[]` として保持する
- 実績名の重複は許容する
- 「来なかった」は予定と実績の差分で扱う
- `dutyStamps` はセッション枠ごとの捺印実績を保持する
- `dutyStamps` のキーはセッションの `order` を文字列化した値を使用する
- `dutyStamps.{order}` は `stampedByUid` / `stampedByName` / `stampedAt` を持つ

### 19.4 sessions/{sessionId}/rsvps/{uid} フィールド例（出欠予定）

```json
{
  "status": "yes",
  "comment": "部活後に通院予定",
  "updatedAt": "serverTimestamp",
  "displayNameSnapshot": "田中太郎"
}
```

- 管理単位はセッション単位（AM/PM など枠ごと）
- `status` は `yes` / `maybe` / `no` / `unknown`（`unknown` は未回答）
- カード表示では `unknown` を集計・表示しない
- Today の出欠モーダルは参照専用（編集不可）
- Today の出欠モーダルでは `unknown` を `-` 表示する
- 日誌の出欠モーダルは編集可能（`yes` / `maybe` / `no` の排他選択）
- 日誌の出欠モーダル保存時は未選択（`unknown`）を許可しない

### 19.5 計画→実績の関係（実装方針）

- 日誌入力時にスケジュール情報を参照して初期表示に利用する
- 計画と実績は強制同期しない
- 自動上書きはしない

---

## 20. 現在の実装状況（DEMO段階）

### 20.1 実装済み

- Today日付ビュー（`/today` + `?date=YYYY-MM-DD`）対応
- date不正値時のJST本日フォールバック対応
- Today日付ナビ（前日/翌日 + ミニカレンダー）対応
- 日誌未作成日の「日誌を作成」導線と、未来日作成時の確認ダイアログ対応
- Today備考の3行折りたたみ / インライン展開 / 展開時スクロール補正対応
- 活動記録の曲追加UI（候補タップ / Enter で追加、`追加` ボタン無し、`キャンセル` のみ）
- 曲追加の重複防止（同一 `songId` は追加しない）
- 曲未解決 / 重複時のローカルトースト表示（約2秒、自動消去、連続時は上書き）
- 活動記録モーダル：`種別` 必須、未入力時は保存せずエラー表示
- `種別` のエラーはラベル行右側に表示（ドロップダウンに隠れない）
- 活動記録一覧：時刻列固定幅 + 右寄せで `～` を縦に揃える
- 4桁時刻でも改行しない（`minmax(8ch, max-content)` + `nowrap`）

### 20.2 未実装 / 今後

- スケジュール→日誌の省力化参照（入力補助の拡張）
- シフト草案生成
- 会計機能の本実装
- 権限制御（ロールごとの厳密な制御）

---

変更点サマリ（最大5行）
- 日誌の当番ハンコを「予定表示」ではなく「捺印実績」扱いとして明記
- 第5章に当番ハンコ（未捺印=予定当番名、捺印済=捺印者名、上書き時Confirm）の仕様を追記
- 第19章に `dayLogs.dutyStamps`（`stampedByUid`/`stampedByName`/`stampedAt`）を追記
- 予定当番（計画）と捺印実績（実績）は別概念で非同期とする方針を明記
- 既存方針（1日1日誌、計画と実績の非強制同期）との整合を維持



