# Windoms README v0.1

プロジェクト名: **Windoms（Wind Orchestra Management System）**  
吹奏楽専用 管理OS

---

## 1. 目的とコンセプト

Windoms は、吹奏楽クラブの運営に必要な機能を統合する管理システム。

- 日誌
- スケジュール
- シフト
- 会計
- 月謝管理
- 備品管理
- 楽譜・楽器管理

単機能ツールではなく、運営情報を横断して扱える基盤を目指す。

---

## 2. 基本思想

- 年度は 9/1 開始
- 現場負担を増やさない
- リアルタイム入力優先
- 紙運用は急に廃止しない（徐々に置換）
- バッチ処理は極力不要
- 入力負担より「使われ続けること」を優先
- 検索できることが価値
- 将来AI統合可能
- 小さく作って育てる

---

## 3. 用語定義（統一）

- **セッション（枠）**: スケジュールの基本単位
- **日誌**: 1日1枚の実績記録
- **活動ログ（タイムライン）**: 日誌内で時刻順に記録する実施内容

---

## 4. スケジュール管理（計画）

### 4.1 基本構造

- 管理単位は「セッション（枠）」
- 1日は 1〜複数セッションで構成
- 基本運用:
- 平日: 1セッション
- 土日: 基本2セッション
- 「午前/午後」は固定ラベルではなく、UI表示上で違和感なく扱う

TODO: 未決定（セッション名の最終表示ルール）

### 4.2 セッション管理項目

- 活動種別（通常 / 自主練 / イベント）
- 開始時刻 / 終了時刻
- 活動場所（第1/2/3音楽室 or 自由入力）
- 当番必要/不要

### 4.3 .ics 出力

- 月間スケジュール（セッション）から月単位で .ics を生成
- 1セッション = 1イベント

タイトル生成ルール:
- 通常: `【吹奏楽】{当番者名}`
- イベント日: `【吹奏楽】{当番者名} {イベント名}`
- 自主練: `【吹奏楽】自主練`

補足:
- 自主練の見守り担当は、初期仕様ではタイトルに含めない
- LOCATION はスケジュールの活動場所を使用
- イベント時は会場名などを LOCATION として設定可能

### 4.4 Today（日付ビュー）仕様

- Todayは「日付ビュー」として動作する
- URL仕様:
- `/today` は JST基準の本日を表示
- `/today?date=YYYY-MM-DD` は指定日を表示
- `date` が不正値（形式不正 / 実在しない日付）の場合は JST本日にフォールバックする
- 日付ナビUI:
- `← 前日` / `翌日 →` で日付移動し、URLクエリも更新する
- 日付表示（カレンダーアイコン含む）からミニカレンダーを開き、任意日へ移動できる
- ブラウザ戻る / 進むで日付遷移履歴を辿れる
- 日誌との連携:
- 指定日に日誌がある場合は日誌へ遷移できる
- 指定日に日誌がない場合は「日誌を作成」導線を表示する
- 未来日（選択日 > JST本日）で日誌作成する場合は確認ダイアログを表示する

### 4.5 Today備考（notice）表示仕様

- `scheduleDays.notice` はToday上部に表示する（改行反映）
- `scheduleDays.notice` は計画側の連絡事項（Today備考）として扱う
- 初期は3行相当で折りたたむ
- 3行を超える場合のみ、`▼ ひらく / ▲ たたむ` トグルを表示する
- 展開はインラインで行い、全文を読めるようにする
- 展開時は備考エリアが見失われにくいようにスクロール補正する
- 展開後も最大高さを設け、超過分は備考エリア内スクロールで読む

### 4.6 共通メニュー（オーバーレイ）

- 画面右上にメニューアイコン（`☰`）を配置する
- メニュー押下でフルスクリーンのオーバーレイメニューを表示する
- オーバーレイ上部にJSTの今日の日付を大きく表示する（曜日表示を含む）
- 日付文字は暗背景上で白系を基本とし、曜日のみ色分けする（平日=明るいグレー、土=青系、日=赤系）
- 上部の日付ヘッダを押すと Today 画面へ遷移する
- ヘッダ下にスマホホーム画面風のアイコングリッドを表示する
- メニューは以下の3セクション構造とする（見出しは小さめ淡色）:
- 運用: Today / 日誌 / カレンダー / TODO
- 活動予定: 活動予定 / 出欠 / 見守り
- 管理: 会計 / 楽器 / 楽譜 / 資料 / メンバー / リンク集 / 設定
- 当番可否アンケートは月1回イベントのため、専用メニューは追加しない
- 気づき導線として、運営向けに「活動予定」メニューへ未回答バッジ（SURVEY_OPEN中のみ）を表示する
- 気づき導線として、運営向けにホーム上部へ「今月のTODO」カードを状態優先度で1枚表示する
- 一般メンバーは当月の活動予定確認を基本「カレンダー」から行う
- 各セクション内のグリッドはレスポンシブで自動列数調整（スマホ3列前後、PCはより多列）とする
- オーバーレイ内に白い大枠コンテナは置かず、暗背景上に直接グリッドを配置する
- アプリ名ラベルは原則1行表示（改行させない）
- 旧「スケジュール」は削除し、「カレンダー」「活動予定」に分割する
- Dock（下部固定タブ）は採用しない
- 閉じ方は `×` ボタンを基本とし、背景クリックで閉じる（Esc閉じるはPCで許容）
- DEMO段階では、未実装モジュールは仮遷移（viewパラメータ等）で導線のみ確保する

---

## 5. 日誌モジュール（実績ログ）

### 5.1 基本構造

- 日誌は **1日1枚**
- 日誌の `notes` は実績側の記録メモ（日誌メモ）として扱う
- 1日共通情報:
- 活動時間（通し）
- 活動場所（1つ）
- 講師（メイン指導者）はセッション単位で扱う
- 外部講師（1日単位）
- 先輩（1日単位）
- セッション別に分ける主対象:
- 当番
- 出欠（人数 + 欠席者名任意）
- 日誌画面には Today備考（`scheduleDays.notice`）を表示しない
- Today備考（計画側）と日誌メモ（実績側）は別フィールド・別概念として扱う
- Today備考と日誌メモは相互に同期しない
- 当番ハンコは「予定表示」ではなく「捺印（実績）」で確定する
- 予定当番（計画）と捺印実績（実績）は別概念として扱い、強制同期しない
- 講師（メイン指導者）の予定（計画）と実績（日誌）は別概念として扱い、強制同期しない

### 5.2 活動ログ（タイムライン）

- 1日通しで入力
- 時刻順で並ぶ（自動ソート）
- 開始時刻のみ（終了時刻不要）
- 5分刻み
- 初期値は現在時刻に最も近い5分
- 入力はリアルタイム前提（後日入力最適化は不要）

### 5.3 活動種別と曲名

活動種別:
- 筋トレ
- 腹式呼吸
- 基礎練習
- 個人練習
- 合奏
- 休憩
- その他（自由入力）

曲名:
- 合奏は曲名入力あり
- 個人練習も曲名を任意で入力可能
- 曲は複数選択を許容（`songIds`）
- 表示は開始時刻ベースで、必要に応じて「種別（詳細 / 曲名）」を併記する

### 5.4 検索価値

- 曲名検索（初回練習日など）
- 先輩検索（来訪履歴）
- パート検索
- 種別検索

日誌は「練習履歴データベース」として機能する。

### 5.5 実績入力UI方針（講師・先輩）

- `actualInstructors` / `actualSeniors` は配列UIで編集する（カンマ区切り入力は採用しない）
- 追加済みは行リストで表示し、各行の削除で1要素ずつ配列から除去する
- 追加はインライン入力（`＋追加`）で行う
- 候補は入力欄一体型のドロップダウンで表示する
- 候補優先順位は `planned（未追加分）` → `履歴（過去 dayLogs の actual）` → `自由入力`
- 候補クリックで即追加する
- 空文字（trim後）は追加しない
- 重複値は許容する（配列としてそのまま保持）

### 5.5.1 講師（メイン指導者）の予定/実績

- メイン講師は単数で扱う（現状: 井野先生）
- 在席はセッション単位で扱う
- 予定はスケジュール側（`sessions.plannedInstructors`）を参照する
- 実績は日誌側でセッション単位チェックとして記録する
- 実績チェックの初期状態は全セッション未チェック
- 予定がOFFでも実績をONにできる
- 予定がONでも実績をOFFにできる
- 予定と実績は同期しない
- メイン講師は外部講師として扱わない

### 5.6 活動記録UI（一覧・モーダル）

- 一覧は「開始時刻～ / 種別（補足・曲名）」で表示する
- 開始時刻はゼロ埋めしない（例: `9:05`）
- 一覧表示は時刻列を固定幅・右寄せにし、`～` の位置を縦に揃える
- 4桁時刻（例: `16:35～`）でも時刻表示は改行しない
- 活動記録モーダル保存時、`種別` は必須とする
- `種別` 未入力で保存した場合は、保存せずエラー表示する
- エラー表示は `種別` ラベル行の右側に表示する（ドロップダウンに隠れない位置）

### 5.7 活動記録の曲追加UI（DEMO）

- `songIds` は `string[]` で保持し、最大10件
- 曲追加はサジェスト候補タップまたは Enter で行う
- 曲追加UIのアクションは `キャンセル` のみ（`追加` ボタンは置かない）
- 入力文字列は `songMaster.name` と一致する場合のみ追加する（trimして判定）
- 同一曲の重複追加は行わない
- 曲が解決できない場合や重複追加時は、入力欄上にローカルトーストでフィードバックを表示する
- トーストは短時間（約2秒）で自動消去し、連続発生時は上書きする

### 5.8 当番ハンコ（捺印実績）

- 初期表示は未捺印（薄グレー）
- 未捺印時は「予定当番名（計画）」を表示する
- タップで捺印し、赤色表示へ切り替える
- 捺印済みは「捺印者名（実績）」を表示する
- 捺印時に軽いスタンプ演出を行う（過度な演出はしない）
- 他人枠をタップした場合は Confirm を表示し、承認時のみ上書き捺印する
- 同一捺印者が再タップした場合は無反応にせず「捺印済み」等でフィードバックする

---

## 6. 出欠管理

現状:
- 月初に保護者が予定入力
- 実績は未管理

将来:
- 予定出欠入力（部員/保護者）
- 実績は日誌で管理
- パート別出席確認可能

---

## 7. シフト管理

### 7.1 流れ

1. 前月末に当番可能日入力
2. 草案作成（AI利用可能）
3. 手動微調整
4. 月間確定
5. 通知

### 7.2 AI活用（将来）

- 条件ベース初期草案
- 回数バランス考慮
- 可否考慮
- 人間が最終調整

---

## 8. 会計モジュール（簡易出納帳）

### 8.1 財布管理

- ゆうちょ口座
- 会計担当財布
- 会長財布
- 将来複数口座対応

### 8.2 機能

- 収入
- 支出
- 口座間振替
- カテゴリ（2階層）
- 年度繰越
- 年度報告書
- グラフ表示

### 8.3 月謝管理連携

- 4ヶ月ごと集金
- 袋配布リマインド
- 配布済 / 回収済管理
- 未納管理

---

## 9. 備品管理

- 不足報告
- 購入記録
- 会計連携
- レシート画像添付
- 精算待ち管理

---

## 10. 楽譜管理

- 曲名
- 所持数
- パート
- 購入履歴
- 貸出管理（将来）

---

## 11. 楽器管理

現状:
- 紙台帳

将来:
- デジタル貸出
- 使用者管理
- 状態管理
- 部員ロール対応

---

## 12. ロール設計（暫定）

- シス管
- 会計担当
- 役員
- 保護者
- 部員
- 先生

方針:
- モジュール単位で閲覧/編集権限
- 会計は厳格
- 日誌・スケジュールは広く閲覧可
- 将来柔軟拡張

---

## 13. MVP候補

1. スケジュール管理
2. 日誌モジュール
3. シフト管理
4. 会計（簡易版）
5. .ics出力

---

## 14. 設計原則（詳細）

### 14.1 データ整合性ポリシー

- データの正しさはデータモデルで担保する
- フロント補完に依存しない
- 自動生成データには「自動連携フラグ」を持たせる
- 修正・削除は可能とするが、連携取引は警告対象とする
- 集計のためのバッチ前提設計をしない

### 14.2 修正・削除ポリシー

- 実運用を止めない設計にする
- 修正可能な設計を基本とする
- 削除は論理削除も検討する
- 会計連携データは削除制限を検討する

### 14.3 バッチ非依存ポリシー

- 月次締めバッチを前提にしない
- 日次バッチを前提にしない
- リアルタイム入力を即反映させる設計
- 年度切替は明示的に操作する

### 14.4 年度管理ポリシー

- 年度は 9/1 開始
- 年度データは分離可能な構造にする
- 年度繰越は明示的に記録する
- 前年度比較は将来拡張とする

---

## 15. 会計思想

Windomsの会計は「簡易出納帳」であり、複式簿記は対象外とする。

### 15.1 財布中心設計

- すべての取引は「財布」を起点にする
- 財布は複数持てる
- 口座間振替は標準機能

### 15.2 月謝連携

- 月謝管理からの取引は自動生成可能
- 自動生成取引にはフラグを持たせる
- 必要に応じて手動修正可能

### 15.3 精算管理思想

- 立替は「精算待ち」状態を持つ
- レシート画像添付を前提とする
- 精算完了時に会計記帳する

---

## 16. プロダクト哲学

Windomsは「吹奏楽クラブ運営者の心理的・物理的負担を軽減するOS」である。

- シフト作成者の心理的負担を軽減する
- 情報が分散しない安心感を提供する
- 検索可能な履歴を蓄積する
- 運営が属人化しない状態を目指す

---

## 17. 計画と実績の関係

- スケジュールは「計画」を管理する
- 日誌は「実績」を記録する
- 両者は直接の強制同期を行わない
- 必要に応じて参照関係を持つが、自動上書きはしない

---

## 18. データ削除原則

- 実運用データは原則物理削除しない
- 論理削除（isDeleted 等）を基本とする
- 会計データは履歴保持を優先する
- 削除より「無効化」を優先する

---

## 19. データモデル（案）

前提（確定事項）:
- 年度は 9/1 開始
- `YYYY-MM-DD` は年度に依存しない絶対日付として保持する
- `scheduleDays` のIDは `YYYY-MM-DD`
- `scheduleDays/{YYYY-MM-DD}` は docId が `YYYY-MM-DD`（フィールドに `id` / `date` は持たない）
- `sessions` は `scheduleDays/{date}/sessions/{sessionId}` のサブコレクション
- `sessions` のIDは自動ID、並び順は `order`（数値）で保証
- `startTime` / `endTime` は `HH:MM` 文字列（JST前提）、基本30分単位（将来拡張可）
- `type` は最小で `normal` / `self` / `event`
- 保護者が不要な日は無い
- `dutyRequirement` を `sessions` に持つ（`duty` / `watch`）
- `duty` は当番シフト割当対象、`watch` は見守り募集対象
- 当番シフト割当（`duty`）と見守り募集（`watch`）は別機能で扱う
- `requiresShift` は当番シフト割当対象を示す旧フラグで、`dutyRequirement` へ移行する
- 互換期間中に `requiresShift` を持つ場合は `dutyRequirement === "duty"` と同義で扱う
- `location` は `sessions` に持てる
- 入力省力化として `scheduleDays.defaultLocation` を任意で持ち、`session.location` が無い場合は `day.defaultLocation` を継承
- 当番者は `sessions.assignees: [uid]` で保持（運用上は原則1名）
- 表示・ics生成省力化のため `assigneeNameSnapshot` を任意で保持可（UIDが正）
- `plannedInstructors` / `plannedSeniors`（予定の講師・先輩）を `sessions` に持てる
- 曲マスタは `songMaster/{songId}` として保持する（`name` 必須）
- 日誌は `dayLogs/{YYYY-MM-DD}`（1日1枚）
- 日誌から「活動場所」「顧問」は削除（不要）
- 日誌は備考 `notes` を持つ
- `weather` は任意（ワンタップ想定）
- 当番の割当単位は「家庭（household）」である。
- 保護者ユーザーは家庭に所属する（父母が別ユーザーとして存在し得る）。
- 当番可否アンケートは家庭単位で集約する。
  - 例: 渋谷父が回答した時点で、渋谷家は回答済となり、渋谷母は追加回答不要。
- 兄弟姉妹は、同じ家庭に子どもが複数所属することで表現できる。
- 親子関係は、家庭メンバーの役割（guardian/child）で最低限表現し、個別の親子紐付けは後続フェーズで拡張する。
- 保護者には、家庭内の続柄（父/母/祖母/叔母/その他 など）を持たせる。続柄は users ではなく household のメンバー情報（membership）に紐付ける（家庭内の関係として扱う）。
- 出欠予定は日単位ではなくセッション単位で管理する（`sessions/{sessionId}/rsvps/{uid}`）
- 日誌はスケジュールを参照して入力を省力化する（第17章の通り強制同期・自動上書きはしない）
- 実績側は `actualInstructors` / `actualSeniors` を持ち、来なかったは「予定にいるが実績にいない」差分で表現する（明示フラグは持たない）
- 実績側は `mainInstructorAttendance`（セッション `order` 単位の在席チェック）を持てる
- 捺印実績は `dayLogs.dutyStamps` に保持し、予定当番とは別で扱う

### 19.1 scheduleDays/{date} フィールド例

```json
{
  "defaultLocation": "第1音楽室",
  "notice": "本日16:30に片付け開始です。\n打楽器は搬出前にチェックリストを確認してください。"
}
```

- ドキュメントIDが `YYYY-MM-DD`（フィールドとして保持しない）
- `defaultLocation` は任意
- `notice` は任意（複数行可。Todayでは改行を反映して表示）

### 19.2 sessions/{sessionId} フィールド例

```json
{
  "order": 1,
  "startTime": "09:00",
  "endTime": "12:00",
  "type": "normal",
  "dutyRequirement": "duty",
  "requiresShift": true,
  "location": "第1音楽室",
  "assignees": ["uid_123"],
  "assigneeNameSnapshot": "山田花子",
  "plannedInstructors": ["講師A"],
  "plannedSeniors": ["先輩B"]
}
```

- `sessionId` は自動ID
- 並び順は `order` で制御
- `dutyRequirement` は `duty` / `watch`
- `requiresShift` は旧フラグ（互換）。`dutyRequirement === "duty"` と同義
- `location` 継承の優先順位:
1. `session.location`
2. `scheduleDays.defaultLocation`
3. 未設定（空欄）

### 19.3 dayLogs/{date} 最小フィールド例

```json
{
  "notes": "備考メモ",
  "weather": "晴れ",
  "activities": [
    {
      "startTime": "09:05",
      "type": "基礎練習",
      "title": "ロングトーン",
      "songIds": ["song_001", "song_002"]
    }
  ],
  "dutyStamps": {
    "1": {
      "stampedByUid": "demo_writer",
      "stampedByName": "日誌記入者",
      "stampedAt": "2026-02-15T00:12:34.000Z"
    }
  },
  "actualInstructors": ["講師A"],
  "actualSeniors": ["先輩B"],
  "mainInstructorAttendance": {
    "1": true,
    "2": false
  }
}
```

- ドキュメントIDが `YYYY-MM-DD`（フィールドとして保持しない）
- `activities` は活動ログ（開始時刻ベース）
- `activities` は `startTime` 昇順で表示・扱う
- 同一 `startTime` がある場合は登録順で扱う
- `activities.songIds` は任意（0件以上、複数曲を許容）
- `actualInstructors` / `actualSeniors` は `string[]` として保持する
- `mainInstructorAttendance` はセッション `order` をキーにした在席実績（boolean）を保持する
- 実績名の重複は許容する
- 「来なかった」は予定と実績の差分で扱う
- `dutyStamps` はセッション枠ごとの捺印実績を保持する
- `dutyStamps` のキーはセッションの `order` を文字列化した値を使用する
- `dutyStamps.{order}` は `stampedByUid` / `stampedByName` / `stampedAt` を持つ

### 19.4 sessions/{sessionId}/rsvps/{uid} フィールド例（出欠予定）

```json
{
  "status": "yes",
  "comment": "部活後に通院予定",
  "updatedAt": "serverTimestamp",
  "displayNameSnapshot": "田中太郎"
}
```

- 管理単位はセッション単位（AM/PM など枠ごと）
- `status` は `yes` / `maybe` / `no` / `unknown`（`unknown` は未回答）
- カード表示では `unknown` を集計・表示しない
- Today の出欠モーダルは参照専用（編集不可）
- Today の出欠モーダルでは `unknown` を `-` 表示する
- 日誌の出欠モーダルは編集可能（`yes` / `maybe` / `no` の排他選択）
- 日誌の出欠モーダル保存時は未選択（`unknown`）を許可しない

### 19.5 計画→実績の関係（実装方針）

- 日誌入力時にスケジュール情報を参照して初期表示に利用する
- 計画と実績は強制同期しない
- 自動上書きはしない

---

## 20. 現在の実装状況（DEMO段階）

### 20.1 実装済み

- Today日付ビュー（`/today` + `?date=YYYY-MM-DD`）対応
- date不正値時のJST本日フォールバック対応
- Today日付ナビ（前日/翌日 + ミニカレンダー）対応
- 日誌未作成日の「日誌を作成」導線と、未来日作成時の確認ダイアログ対応
- Today備考の3行折りたたみ / インライン展開 / 展開時スクロール補正対応
- 活動記録の曲追加UI（候補タップ / Enter で追加、`追加` ボタン無し、`キャンセル` のみ）
- 曲追加の重複防止（同一 `songId` は追加しない）
- 曲未解決 / 重複時のローカルトースト表示（約2秒、自動消去、連続時は上書き）
- 活動記録モーダル：`種別` 必須、未入力時は保存せずエラー表示
- `種別` のエラーはラベル行右側に表示（ドロップダウンに隠れない）
- 活動記録一覧：時刻列固定幅 + 右寄せで `～` を縦に揃える
- 4桁時刻でも改行しない（`minmax(8ch, max-content)` + `nowrap`）

### 20.2 未実装 / 今後

- スケジュール→日誌の省力化参照（入力補助の拡張）
- シフト草案生成
- 会計機能の本実装
- 権限制御（ロールごとの厳密な制御）

---

変更点サマリ（最大5行）
- 共通メニューの日付表示を暗背景向けに調整（白系文字 + 曜日色分け）する仕様を追記
- オーバーレイ内の白い大枠コンテナを使わない方針を明記
- メニューラベルを原則1行表示（改行防止）する仕様を追記
- メニュー項目に「楽器」を追加し、「メンバー／ロール」を「メンバー」に更新
- DEMOバッジとメニュー操作が干渉しない配置方針を明確化

---

## 21. 設計思想の追記（Session / Event / Task / Today / Action Bar）

### 21.1 データモデル設計思想（Session / Event / Task）

- Session：日時を持つ活動単位（Today/日誌の起点）
- Event：意味のまとまり（コンサート/コンクール/合宿等）。時間はSession側に持たせる考え方（Event自体は日時必須ではない）
- Task：実行単位（TODO）

### 21.2 EventとSessionの関係

- Eventは0個以上のSessionを持てる
- SessionはEventを0 or 1持つ
- N対Nは不要（当面やらない）
- 例：合宿はEvent1つに対して複数Session（各日の練習枠）
- 例：本番に向けた事前練習3回も同じEventに紐付けて見られる

### 21.3 Taskの紐付け（XORルール）

- Taskは紐付け先を最大1つ（none / sessionId / eventId）
- 同時にsessionIdとeventIdの両方は持たない
- Eventに紐付いたTaskは、関連Session側でも「表示」は可能（データ重複はしない）

### 21.4 Today画面の役割（Notice含む）

- Todayは運営の現在地（起点画面）
- Noticeは「手動作成型」と「自動生成型」を想定
- 通知ログではなく「今、知るべきこと」を表示する層

### 21.5 Action Bar（ステータスバー）

- Todayヘッダー右側にステータスアイコン（🔔/✅/📅）を置く
- Action Bar（ステータスバー）はWindoms共通ヘッダーとして全画面に表示する
- バッジで件数を示し、タップで各パネルを開く
- ハンバーガーは最右固定（メニューは既存のオーバーレイ方式を維持）

### 21.6 表示ルール（Taskの見せ方）

- Sessionに紐付くTaskは、そのSession詳細画面に表示される。
- Eventに紐付くTaskは、Event詳細画面に表示される。
- Event配下のSession画面では、Event由来のTaskも参照表示できる（ただしデータは重複保存しない）。
- Session由来のTaskとEvent由来のTaskは、表示上区別できるようにする（例：バッジ表示など）。
- Taskの保存先は常に一意であり、表示のためにコピーを作らない。

---

## 22. スケジュール機能のモジュール分離

### 22.1 カレンダー（全員向け）

- クラブ共有予定の閲覧画面
- 個人予定は自分のみ編集可能（他人非公開）
- クラブ予定は全員閲覧可能
- 「出来上がった世界を見る」モジュール

### 22.2 活動予定（管理者向け）

活動予定は「月を作る場所」である。  

- 活動予定（activity-plan）の作成対象月は、原則「翌月」とする。
  - 例: 現在が 2026-02 の場合、操作対象は 2026-03。
- DEMO段階では「翌月固定」でよい（対象月の切替UIは後回し）。

### 22.2.1 活動予定（MonthlyPlan）の最小データ

活動予定は「月次の作業台」であり、月ごとに1つ存在する。

- monthKey: "YYYY-MM"（例: "2026-02"）
- status: NOT_STARTED | SESSIONS_SET | SURVEY_OPEN | SURVEY_CLOSED | AI_DRAFTED | SHIFT_CONFIRMED | NOTIFIED
- updatedAt: ISO文字列またはタイムスタンプ
- publishedAt?: ISO文字列またはタイムスタンプ（通知済みになった時点でセット）

DEMO段階では、MonthlyPlanの永続化は仮実装でよい（ローカル状態でも可）。

### 22.2.2 活動予定（月次）画面の表示方針

活動予定の月次画面は「格子カレンダー」ではなく、帳票（リスト）形式で表示する。
1日を1行として縦に日付が並び、各行にその日のセッション枠・当番・先生予定・外部指導者・備考を表示する。
見た目は現行の月次活動予定ドキュメント（PDF）に近い形式を目指す。
- 当番は独立列ではなく、当番が必要なセッション（通常練習/イベント等）のセル内に表示する。
- 自主練は見守り表示を行わない（見守りは別モジュールで扱う）。
- 「基本プリセットを入れる」は `NOT_STARTED` のときのみ表示する。
- セッション追加は `NOT_STARTED` のときのみ可能とし、月次表の空セル（AM/PM/夜）から行う。
- セッション削除（×）とプリセット投入も `NOT_STARTED` のときのみ可能とする。
- `NOT_STARTED` では下書きを作成し、確認後に「練習日を決定する」で `SESSIONS_SET` に進める。
- 先生予定・備考は全ステータスで編集可能とする。
- プリセット投入時は、土日でセッションが入る日の先生予定に `9:00-15:00` を初期投入する（既存値は上書きしない）。
- 外部指導者・先輩等の随時追記情報は、この作成フェーズ画面では扱わない（後続フェーズ/別画面で扱う）。

月次フローは以下の状態で進行する：

1. NOT_STARTED
2. SESSIONS_SET
3. SURVEY_OPEN
4. SURVEY_CLOSED
5. AI_DRAFTED
6. SHIFT_CONFIRMED
7. NOTIFIED

- シフトは独立モジュールではなく、活動予定の一工程とする
- NOTIFIED後も閲覧・PDF出力は可能だが、活動予定・当番シフト・先生予定・備考は変更不可とする。
- 状態は月次儀式の到達点であり、変更時に巻き戻さない

### 22.2.3 アンケートの位置づけ（当番可否/参加可否）

- Windomsには「アンケート」が2種類ある。
  - 当番可否アンケート（工程内）: MonthlyStatus の SURVEY_OPEN / SURVEY_CLOSED は「当番可否」を集める工程である。ここで集めた結果を元に、当番仮割当（AI_DRAFTED）→当番確定へ進む。
  - 練習参加可否（工程外・常設）: 練習日と当番シフトが確定し、PUBLISHED（通知済）になったタイミングで「参加可否の入力」が可能になる。参加可否はその後も随時更新できる想定であり、MonthlyStatus の工程とは独立した常設機能として扱う。参加可否の入力画面/導線は後続フェーズで設計する。
- PUBLISHED（通知済）到達時に「練習予定・当番シフトの確定通知」と「全員が確認できる共有手段の提供（URL/PDF等）」と「参加可否入力の解放」が同時に成立する。

### 22.2.4 当番可否アンケート仕様（工程内）

- 対象: 保護者全員
- 質問: 当番が必要なセッションを縦に並べ、各セッションに対して ◯ / △ / × で回答する
- 期限: 送信時に期限を設定でき、デフォルトは「3日後」
- 実行可能ステータス: SESSIONS_SET（練習日決定）でのみ「アンケート送信」が可能。それ以外では送信UIを出さない
- Windoms内で実施（外部フォームは使わない）
- SURVEY_CLOSED 到達後、「AIで当番を仮割当」を実行できる。
- 仮割当の実行により MonthlyStatus は AI_DRAFTED へ遷移する。
- AI_DRAFTED の期間のみ、当番（duty）の手修正が可能とする（他ステータスでは不可）。
- 見守り（watch）は本モジュールでは割当・編集しない。
- SURVEY_CLOSED では「AIで当番を仮割当」だけでなく、「AIを使わずに当番編集へ進む（AI_DRAFTEDへ遷移）」導線も持つ（AI不調時等の緊急回避）。
- AI_DRAFTED の当番編集は「候補から選択する」方式とし、自由入力はしない。
- 当番可否（◯△×）の結果は、当番編集時に参照できる形にする（入力UI/連動は後続フェーズで実装し、DEMOでは未実装表示でもよい）。
- AI_DRAFTED 以降、月内の各家庭の当番割当数を確認できる（モーダル等）。
- 手修正による割当変更は、この集計に即時反映される。
- AI_DRAFTED の次ステータスとして SHIFT_CONFIRMED を持つ。
- AI_DRAFTED では「シフトを確定する」操作を実行でき、確認後に SHIFT_CONFIRMED へ遷移する。
- SHIFT_CONFIRMED では当番編集をロックし、閲覧のみ可能とする。
- SHIFT_CONFIRMED の編集ロックはUI表示だけでなく、ロジック上でも当番編集不可を保証する。
- SHIFT_CONFIRMED では当番回数確認モーダル等の閲覧機能は利用できる。
- SHIFT_CONFIRMED では当番編集に加えて、先生予定・備考の編集もロックする。
- SHIFT_CONFIRMED では PDF出力（複数回可）と「全メンバーに通知する」操作のみ実行できる。
- 「全メンバーに通知する」実行後は NOTIFIED に遷移し、通知ボタンは再表示しない。
- NOTIFIED は活動予定と当番シフトの通知が完了した状態を示し、出欠予定入力を解放する。

### 22.3 見守り（自主練）

- 自主練は通常セッションと同様に1セッション
- `dutyRequirement: "watch"` を持つセッションが対象
- 月初に割り当てない
- 随時挙手で1枠1人を募集
- 未確定 / 確定状態を可視化
- 日誌上では当番と同様に捺印対象となり得る

---

## 23. ルーティング設計方針（DEMO段階）

### 23.1 モジュール単位の独立ルート

Windomsでは、モジュールとして存在が確定した時点で独立ルートを与える。

例:
- /today
- /activity-plan
- /calendar
- /journal

独立ルートは、そのモジュールが今後仕様を詰めていく前提で存在することを意味する。

### 23.2 today?view= の扱い

/today?view=xxx は、以下用途でのみ使用する：
- 仕様未確定モジュールの仮表示
- DEMO中の一時的な画面確認
- 構造検討中のUIの暫定置き場

正式モジュールに昇格したものは、today?view= では扱わない。

### 23.3 昇格ルール

- 機能として存在が確定
- 今後継続して仕様を詰める対象
- ナビゲーションに正式表示する

これらを満たした時点で独立ルートを与える。

### 23.4 現在の適用状況（DEMO）

- activity-plan は正式モジュールとして独立ルートを持つ
- その他未確定モジュールは today?view= のままとする


## データモデル基本構造（Schedule × Event × TODO）

Windomsにおける中核モデルは、以下の3要素で構成される。

- **Schedule（スケジュール / セッション）**
- **Event（イベント / 上位概念）**
- **TODO（タスク）**

この3つは役割が明確に分かれており、責務が重ならない設計とする。

---

### 1. Schedule（セッション単位）

Scheduleは「日時を持つ最小の活動単位」である。

例：
- 2/18 練習（18:00-21:00）
- 合宿1日目 午前練習
- 本番当日リハーサル

#### 特徴

- 必ず日時を持つ
- Today表示の主役
- Eventに0または1で紐づく
- TODOを複数持てる

Scheduleは「時間軸の単位」であり、概念のまとまりではない。

---

### 2. Event（上位概念）

Eventは「目的を持つまとまり」である。

例：
- 定期演奏会
- 夏合宿
- アンサンブルコンテスト
- 保護者説明会

#### 特徴

- 日付レンジを持てる
- 複数のScheduleを内包できる（1対多）
- TODOを直接持てる

Eventは「物語・プロジェクト単位」であり、時間の最小単位ではない。

---

### 3. TODO（タスク）

TODOは「やるべきこと」の単位である。

例：
- 楽譜印刷
- 見守り入力
- 当番申請
- 事前練習参加確認

#### 特徴

- 単体でも存在可能
- Scheduleに紐付け可能
- Eventに紐付け可能
- 両方に同時紐付けはしない（設計単純化のため）

TODOは責務単位であり、時間やプロジェクトの概念ではない。

---

## 関係性ルール

| 関係 | ルール |
|------|--------|
| Event → Schedule | 1対多 |
| Schedule → Event | 0または1 |
| Schedule → TODO | 1対多 |
| Event → TODO | 1対多 |
| TODO → Schedule | 0または1 |
| TODO → Event | 0または1 |

※ TODOはScheduleとEventの両方に同時紐付けしない。

---

## 合宿パターン例

例：夏合宿

Event：
- 夏合宿2026

Schedule：
- 1日目 午前練習
- 1日目 午後練習
- 2日目 午前練習

TODO：
- 持ち物確認（Event紐付け）
- 1日目見守り（Schedule紐付け）
- 係分担決定（Event紐付け）

---

## 削除ポリシー（暫定）

- Event削除時：
  - 紐付くScheduleはEventなし状態に戻す（削除しない）
  - 紐付くTODOも同様に孤立させる

- Schedule削除時：
  - 紐付くTODOは孤立させる

物理削除ではなく、構造の崩壊を避ける。

---

## 設計思想まとめ

- Scheduleは時間軸
- Eventは物語軸
- TODOは責務軸

この三軸が交差することで、Windomsはクラブ運営の全体像を表現する。


